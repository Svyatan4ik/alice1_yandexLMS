#!/bin/bash
# deploy_alice_skill.sh - –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –Ω–∞–≤—ã–∫–∞ –ê–ª–∏—Å—ã

# –í—ã—Ö–æ–¥ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
set -eu

# --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ---
APP_NAME="alice_skill"
GIT_REPO="https://github.com/Svyatan4ik/alice1_yandexLMS"  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
PYTHON_VERSION="3.9"                                     # –í–µ—Ä—Å–∏—è Python
PORT=5000                                               # –ü–æ—Ä—Ç –¥–ª—è Flask

# --- 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π ---
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
command -v python3 >/dev/null 2>&1 || { echo "‚ùå Python3 –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"; exit 1; }
command -v git >/dev/null 2>&1 || { echo "‚ùå Git –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"; exit 1; }

# --- 2. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è ---
echo "üì• –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π..."
if [ ! -d "$APP_NAME" ]; then
  git clone "$GIT_REPO" "$APP_NAME"
  cd "$APP_NAME"
else
  cd "$APP_NAME"
  git pull
fi

# --- 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è ---
echo "üêç –°–æ–∑–¥–∞–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ Python $PYTHON_VERSION..."
python3 -m venv venv
source venv/bin/activate

# --- 4. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π ---
echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
pip install --upgrade pip
pip install -r requirements.txt

# --- 5. –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ---
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º Flask-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ..."
echo "‚û°Ô∏è –í–µ–±—Ö—É–∫ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–∫–∞–∑–∞–Ω –≤—Ä—É—á–Ω—É—é –≤ –∫–∞–±–∏–Ω–µ—Ç–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞:"
echo "   URL: http://$(hostname -I | awk '{print $1}'):$PORT/post"
echo "   –ò–ª–∏: http://your-public-ip:$PORT/post"

flask run --host=0.0.0.0 --port=$PORT

# --- –ü–æ–¥—Å–∫–∞–∑–∫–∞ –¥–ª—è Ngrok (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ) ---
echo "‚ÑπÔ∏è –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑–≤–Ω–µ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Ngrok:"
echo "   ngrok http $PORT"